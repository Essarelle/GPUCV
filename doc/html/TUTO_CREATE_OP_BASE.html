<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>GpuCV: Creating a GpuCV operator - base concept -</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="twiki_style.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="TUTO_CREATE_OP_BASE">Creating a GpuCV operator - base concept - </a></h1><h2><a class="anchor" id="TUTO_CREATE_OP_BASE__SCT_INTRO">
Intro</a></h2>
<dl class="user"><dt><b>PRE-REQUIS</b></dt><dd>NONE. </dd></dl>
<dl class="see"><dt><b>See also:</b></dt><dd></dd></dl>
<dl class="author"><dt><b>Author:</b></dt><dd>Yannick Allusse </dd></dl>
<dl class="version"><dt><b>Version:</b></dt><dd>GpuCV v0.4.2 rev 310 </dd></dl>
<dl class="note"><dt><b>Note:</b></dt><dd>Turorial tag: <b>TUTO_CREATE_OP_BASE_TAG</b></dd></dl>
<dl class="user"><dt><b></b></dt><dd>In this tutorial, we will describe how to create and add any operator into GpuCV library by studying the 'addition' operator. We will explain the creation of the filter launcher and its integration into the library. <br/>
<br/>
Follow the key tag <b>TUTO_CREATE_OP_BASE_TAG*</b> in full project source code to have the correspondance of each steps: <ol>
<li>
<a class="el" href="TUTO_CREATE_OP_BASE.html#TUTO_CREATE_OP_BASE__STP1__FIND_DOC">Finding documentation about the specific operators</a> </li>
<li>
<a class="el" href="TUTO_CREATE_OP_BASE.html#TUTO_CREATE_OP_BASE__STP2__LAUNCHER">Writing the operator launcher</a> </li>
<li>
<a class="el" href="TUTO_CREATE_OP_BASE.html#TUTO_CREATE_OP_BASE__STP3__CHOOSE_IMPLEMENTATION">Choosing best implementation</a> </li>
<li>
<a class="el" href="TUTO_CREATE_OP_BASE.html#TUTO_CREATE_OP_BASE__STP4__WRITE_DOC">Documenting the new operator</a> </li>
<li>
<a class="el" href="TUTO_CREATE_OP_BASE.html#CREATING_OP_FILTERS__STP5__TEST_OPERATOR">Testing and benchmarking the new operator</a> </li>
</ol>
</dd></dl>
<dl class="note"><dt><b>Note:</b></dt><dd>This tutorial gives you the main steps for operator integration into GpuCV, for technical implementation see related tutorials.</dd></dl>
<dl class="user"><dt><b>Files to edit</b></dt><dd>First, consider all the files that you might open/create and edit: <ul>
<li>
src/GPUCV/cxcoreg.[cpp/h] for a <b>cxcore</b> operator </li>
<li>
src/GPUCV/cvg.[cpp/h] for a <b><a class="el" href="namespacecv.html">cv</a></b> operator </li>
<li>
src/GPUCV/cvaux.[cpp/h] for a <b>cvaux</b> operator </li>
<li>
src/GPUCV/highgui.[cpp/h] for a <b>highui</b> operator </li>
<li>
src/GPUCV/custom.[cpp/h] for a <b>user custom</b> operator </li>
</ul>
</dd></dl>
<h2><a class="anchor" id="TUTO_CREATE_OP_BASE__STP1__FIND_DOC">
Finding documentation about the specific operators</a></h2>
<p><em>Tag:</em> <b>No tag</b><br/>
 </p>
<dl class="user"><dt><b></b></dt><dd>The new operator you plan to develop might be existing into OpenCV or some other libraries. So te first step is to find the corresponding documentation to macth the function declaration and parameters. <br/>
 <ul>
<li>
<a href="http://picoforge.int-evry.fr/projects/svn/gpucv/opencv_doc/index.htm" target="blank">OpenCV documentation</a></li>
</ul>
<br/>
See example of cvAdd: <div class="fragment"><pre class="fragment"> Add

Computes per-element sum of two arrays

<span class="keywordtype">void</span> cvAdd( <span class="keyword">const</span> CvArr* src1, <span class="keyword">const</span> CvArr* src2, CvArr* dst, <span class="keyword">const</span> CvArr* mask=NULL );

src1
    The first source array. 
src2
    The second source array. 
dst
    The destination array. 
mask
    Operation mask, 8-bit single channel array; specifies elements of destination array to be changed. 

The function cvAdd adds one array to another one:

dst(I)=src1(I)+src2(I) if mask(I)!=0

All the arrays must have the same type, except the mask, and the same size (or ROI size)
</pre></div></dd></dl>
<dl class="note"><dt><b>Note:</b></dt><dd>We strongly recommend you to make benchmarks of the CPU version of the operator before starting implementing, not all operators can be accelerated easily on GPU.</dd></dl>
<h2><a class="anchor" id="TUTO_CREATE_OP_BASE__STP2__LAUNCHER">
Writing the operator launcher</a></h2>
<dl class="user"><dt><b>Goal of the launcher</b></dt><dd>A 'launcher' function is used to execute an operator on GPU. It is subdivided in several steps: <ol>
<li>
Exception handling </li>
<li>
Switching mechanism with native operator </li>
<li>
Hardware compatibility control </li>
<li>
Operator profiling and debugging </li>
<li>
Data pre-processing: controling options and integrity of data, loading them on GPU if needed </li>
<li>
Call GPU operator </li>
<li>
Data post-processing: controling options and integrity of data, read them back to CPU if needed </li>
</ol>
</dd></dl>
<dl class="user"><dt><b>Launcher definition</b></dt><dd><em>Tag:</em> <b>TUTO_CREATE_OP_BASE_TAG__STP2__LAUNCHER</b><br/>
 The function definition must be identical to OpenCV definition except the <b>const</b> qualifier which is not compatible with GpuCV implementation. This is due to some internal mechanisms that might change input CvArr data. See FEATURES_CONST_ISSUE <div class="fragment"><pre class="fragment"><span class="comment">//OpenCV native operator declaration</span>
CVAPI(<span class="keywordtype">void</span>)             cvAdd(const CvArr* src1, const CvArr* src2, CvArr* dst, const CvArr* mask CV_DEFAULT(NULL));
<span class="comment">//GpuCV correspondance declaration</span>
_GPUCV_EXPORT <span class="keywordtype">void</span>      <a class="code" href="group__CVGXCORE__OPER__ARITHM__LOGIC__COMP__GRP.html#ga46fd662a659ad05df9e8b7677d9d1fe5" title="GPUCV correspondence of cvAdd function.">cvgAdd</a>(CvArr* src1, CvArr* src2, CvArr* dst, CvArr* mask CV_DEFAULT(NULL));
</pre></div></dd></dl>
<dl class="user"><dt><b>Launcher MACROS</b></dt><dd>Some MACROS are available to hide some mechanisms complexity and help developers focus on creating operators. Using GPUCV_START_OP/GPUCV_STOP_OP, your operator will perform some steps automatically: <ul>
<li>
Exception handling </li>
<li>
Switching mechanism with native operator </li>
<li>
Hardware compatibility control </li>
<li>
Operator profiling and debugging </li>
</ul>
<br/>
 You have in charge the data transfer to the desired location and the call to your GPU operator.</dd></dl>
<dl class="user"><dt><b>Launcher declaration</b></dt><dd><em>Tag:</em> <b>TUTO_CREATE_OP_BASE_TAG__STP2__LAUNCHER</b><br/>
 Here is an example of the 'addition' launcher definition using MACROS: <div class="fragment"><pre class="fragment"><span class="keywordtype">void</span> <a class="code" href="group__CVGXCORE__OPER__ARITHM__LOGIC__COMP__GRP.html#ga46fd662a659ad05df9e8b7677d9d1fe5" title="GPUCV correspondence of cvAdd function.">cvgAdd</a>( CvArr* src1, CvArr* src2, CvArr* dst, CvArr* mask<span class="comment">/*=NULL*/</span>)
{
        GPUCV_START_OP(cvAdd(src1, src2, dst, mask),    <span class="comment">//If native operator is choosed, this function is called</span>
                <span class="stringliteral">&quot;cvgAdd&quot;</span>,                               <span class="comment">//name of the launcher, it is used for profiling and debugging</span>
                dst,                                    <span class="comment">//destination image, used for profiling</span>
                GenericGPU::HRD_PRF_2); <span class="comment">//Hardware profile to execute the GPU operator</span>
        
                        ...<span class="comment">//this part of code depend on the implementation choosed</span>
        
        GPUCV_STOP_OP(
                cvAdd(src1, src2, dst, mask),   <span class="comment">//in case of error this function is called</span>
                src1, src2, mask, dst           <span class="comment">//in case of error, we get this images back to CPU, so the opencv operator can be called without memory error</span>
                );
}
</pre></div> </dd></dl>
<dl class="note"><dt><b>Note:</b></dt><dd>All operators in development should be writen into the cvgOperators.h and .cpp or in your own files. The cvg.h and cxcoreg.h files are reserved for official GpuCV operators.</dd></dl>
<h2><a class="anchor" id="TUTO_CREATE_OP_BASE__STP3__CHOOSE_IMPLEMENTATION">
Choosing best implementation</a></h2>
<p><em>Tag:</em> <b>No tag</b><br/>
 GpuCV offers you several possibilities to implement your operator: </p>
<ul>
<li>
Pure OpenGL </li>
<li>
OpenGL + GLSL shaders </li>
<li>
NVIDIA CUDA kernels </li>
</ul>
<p>Depending on your skills, the complexity of the operator and the targeted hardware you may choose one or all implementations. See related totorial for more details.</p>
<h2><a class="anchor" id="TUTO_CREATE_OP_BASE__STP4__WRITE_DOC">
Documenting the new operator</a></h2>
<p><em>Tag:</em> <b>TUTO_CREATE_OP_BASE_TAG__STP4__WRITE_DOC</b><br/>
 GPUCV library uses DOXYGEN comment format. Follow this example for your operators. </p>
<div class="fragment"><pre class="fragment"> \fn <span class="keywordtype">void</span> <a class="code" href="group__CVGXCORE__OPER__ARITHM__LOGIC__COMP__GRP.html#ga46fd662a659ad05df9e8b7677d9d1fe5" title="GPUCV correspondence of cvAdd function.">cvgAdd</a>( CvArr * src1,  CvArr * src1, CvArr * dst,  CvArr * mask=NULL)
        \brief GPUCV correspondence of &lt;a href=<span class="stringliteral">&quot;http://picoforge.int-evry.fr/projects/svn/gpucv/opencv_doc/ref/opencvref_cxcore.htm#decl_cvAdd&quot;</span> target=<span class="keyword">new</span>&gt;cvAdd&lt;/a&gt; function.
        \param src1 -&gt; source image
        \param src2 -&gt; additionnal image
        \param dst -&gt; destination image
        \param mask -&gt; mask image (optionnal)
        \note If you have any comment about your Gpu implementation, references to papers, etc...
        \warning If some cases, depending one the input arguments, are not done on GPU, say it here.
        \author YourName(No email)
        \version Version of GpuCV that was used to design <span class="keyword">this</span> <span class="keyword">operator</span>.
</pre></div><h2><a class="anchor" id="CREATING_OP_FILTERS__STP5__TEST_OPERATOR">
Testing and benchmarking the new operator</a></h2>
<p>Go to tutorial <a class="el" href="TUTO_TEST_OP.html">Testing and benchmarking a GpuCV operator</a> to create a testing function. </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Friends</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1">
<table border="0" width="100%">
<tr>
<td>
Retrieve latest informations, releases and documentation on <a href="https://picoforge.int-evry.fr/cgi-bin/twiki/view/Gpucv/Web/WebHome">GpuCV website</a>.
</td>
<td width ="50">
</td>
<td>
<address style="text-align: right;"><small>Generated
on Wed Oct 22 20:37:13 2008 for <a href="https://picoforge.int-evry.fr/cgi-bin/twiki/view/Gpucv/Web/WebHome">GpuCV</a> by&nbsp;
<a href="http://www.doxygen.org/index.html"><img
 src="doxygen.png" alt="doxygen" align="middle"
 border="0"></a> 1.5.4 </small></address>
 </td>
 </tr>
 </table>
